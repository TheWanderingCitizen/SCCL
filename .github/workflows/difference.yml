name: Convert INI to JSON and Compare with Final

on:
  push:
    branches:
      - main

jobs:
  convert-compare-json:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl

    - name: Convert INI to JSON
      run: |
        # 初始化 JSON 数组
        echo "[" > global.json

        # 转换 INI 到 JSON 格式，移除 BOM 和非法字符
        while IFS= read -r line; do
          # 如果存在 BOM，移除它
          line=$(echo "$line" | sed 's/^\xEF\xBB\xBF//')
          
          if [[ "$line" == *"="* ]]; then
            key=$(echo "$line" | cut -d '=' -f 1 | sed 's/["\\]/\\&/g; s/[^[:print:]]//g')
            original=$(echo "$line" | cut -d '=' -f 2- | sed 's/["\\]/\\&/g; s/[^[:print:]]//g')
            echo "  {\"key\": \"$key\", \"original\": \"$original\", \"translation\": \"\", \"context\": \"\"}," >> global.json
          fi
        done < <(iconv -f UTF-8 -t UTF-8 -c global.ini)

        # 移除尾随逗号并关闭 JSON 数组
        sed -i '$ s/,$//' global.json
        echo "]" >> global.json

    - name: Fetch and merge JSON data
      run: |
        # 从 API 获取 JSON 数据
        curl -s -H "Authorization: 5c672e8056d802c52d3398e1376174f0" \
             -H "Cookie: sid=s%3A5c672e8056d802c52d3398e1376174f0.Nvn4B0oVX%2BeUAIP7cSqwkqp7%2BIr8DwL1AhXhpRKs7r8" \
             "https://paratranz.cn/api/projects/8340/files" > files.json
    
        # 初始化空数组用于合并
        echo '[]' > merged_data.json
    
        # 循环遍历每个文件并合并 JSON 数据
        jq -c '.[] | .key' files.json | while read -r key; do
          curl -s -H "Authorization: 5c672e8056d802c52d3398e1376174f0" \
               -H "Cookie: sid=s%3A5c672e8056d802c52d3398e1376174f0.Nvn4B0oVX%2BeUAIP7cSqwkqp7%2BIr8DwL1AhXhpRKs7r8" \
               "https://paratranz.cn/api/projects/8340/files/${key}/translation" > temp.json
          
          # 使用 jq 合并数据，通过 key 合并内容
          jq -s 'reduce .[] as $item ({}; .[$item.key] = (.[$item.key] // {} | . + $item))' merged_data.json temp.json > temp_merged.json
          mv temp_merged.json merged_data.json
        done
    
        mv merged_data.json final.json

    - name: Compare global JSON with final JSON
      run: |
        # 比较 global.json 和 final.json，保留 final.json 的原始文本以防有差异
        jq --argfile final final.json --argfile global global.json \
          '[.[] as $g | $final[] | select(.key == $g.key and .original != $g.original)]' > difference.json

    - name: Upload global.json
      uses: actions/upload-artifact@v3
      with:
        name: global.json
        path: global.json
    
    - name: Upload final.json
      uses: actions/upload-artifact@v3
      with:
        name: final.json
        path: final.json
    
    - name: Upload difference.json
      uses: actions/upload-artifact@v3
      with:
        name: difference.json
        path: difference.json
